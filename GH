--[[

Robust SeedShop / GearShop GUI tracker
Fixes vs your version:
1) Dedup by itemFrame (not only StockText) + tracks both labels
2) Re-hook when MainInfo / labels appear later (UI rebuild / delayed children)
3) Safer "real visibility" check (checks parent chain Visible)
4) Avoid double-wiring on the same frame across rebuilds
5) Still debounce-dumps full list for parse-friendly output

Logs:
warn("SHOP|<KIND>|<JSON>")

]]--

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")

local lp = Players.LocalPlayer
local pg = lp:WaitForChild("PlayerGui")

-- =======================
-- SETTINGS
-- =======================
local DEBOUNCE_SECONDS = 0.40
local TIMER_INTERVAL = 1.0

-- =======================
-- EMIT (PARSE-FRIENDLY)
-- =======================
local function emit(kind, payload)
    warn("SHOP|" .. kind .. "|" .. HttpService:JSONEncode(payload))
end

-- =======================
-- FORCE GUI ENABLED
-- =======================
local function keepGuiEnabled(guiName)
    local gui = pg:WaitForChild(guiName)

    if gui:IsA("ScreenGui") then
        gui.Enabled = true
        gui:GetPropertyChangedSignal("Enabled"):Connect(function()
            if gui.Enabled == false then
                gui.Enabled = true
                emit("INFO", { ts = os.time(), shop = guiName, msg = guiName .. ".Enabled forced true" })
            end
        end)
        emit("INFO", { ts = os.time(), shop = guiName, msg = guiName .. " enabled watcher attached" })
    else
        emit("INFO", { ts = os.time(), shop = guiName, msg = guiName .. " is not ScreenGui (skip Enabled lock)" })
    end

    return gui
end

-- =======================
-- VISIBILITY (parent chain)
-- =======================
local function isActuallyVisible(guiObj)
    if not guiObj or not guiObj:IsA("GuiObject") then return false end
    if not guiObj.Visible then return false end

    local p = guiObj.Parent
    while p do
        if p:IsA("GuiObject") then
            if not p.Visible then return false end
        end
        p = p.Parent
    end
    return true
end

-- =======================
-- FILTER TEMPLATE / HIDDEN
-- =======================
local function isRealItem(guiObj)
    if not guiObj or not guiObj:IsA("GuiObject") then return false end
    if not isActuallyVisible(guiObj) then return false end

    local n = string.lower(guiObj.Name)
    if n == "itemtemplate" then return false end
    if string.find(n, "template", 1, true) then return false end

    return true
end

-- =======================
-- GET LABELS (SEED / GEAR)
-- =======================
local function getItemLabels(shopType, itemFrame)
    local mainInfo = itemFrame:FindFirstChild("MainInfo")
    if not mainInfo then return nil, nil end

    local stockLabel = mainInfo:FindFirstChild("StockText")
    local nameLabel

    if shopType == "SeedShop" then
        nameLabel = mainInfo:FindFirstChild("SeedNameShadow")
    else
        nameLabel = mainInfo:FindFirstChild("GearNameShadow")
    end

    if not nameLabel or not stockLabel then return nil, nil end
    if not nameLabel:IsA("TextLabel") and not nameLabel:IsA("TextButton") and not nameLabel:IsA("TextBox") then
        -- still allow, but most games use TextLabel
    end
    if not stockLabel:IsA("TextLabel") and not stockLabel:IsA("TextButton") and not stockLabel:IsA("TextBox") then
        -- still allow
    end

    return nameLabel, stockLabel
end

-- =======================
-- TRACKER CORE
-- =======================
local dumpScheduled = { SeedShop = false, GearShop = false }
local batchSeq = 0

-- weak maps (keys weak) so if frames are destroyed, entries disappear
local hookedItemFrames = setmetatable({}, { __mode = "k" })
local hookedScrollFrames = setmetatable({}, { __mode = "k" })

local function dumpAll(shopType, scrollingFrame, reason)
    batchSeq += 1
    local batchId = batchSeq
    local ts = os.time()

    emit("BATCH_START", {
        shop = shopType,
        batch_id = batchId,
        ts = ts,
        reason = tostring(reason),
    })

    local count = 0

    for _, item in ipairs(scrollingFrame:GetChildren()) do
        if isRealItem(item) then
            local nameLabel, stockLabel = getItemLabels(shopType, item)
            if nameLabel and stockLabel then
                count += 1
                emit("ITEM", {
                    shop = shopType,
                    batch_id = batchId,
                    ts = ts,
                    name = tostring(nameLabel.Text),
                    stock = tostring(stockLabel.Text),
                    ui_name = item.Name,
                    layout = item.LayoutOrder or 0,
                })
            end
        end
    end

    emit("BATCH_END", {
        shop = shopType,
        batch_id = batchId,
        ts = ts,
        items = count,
    })
end

local function scheduleDump(shopType, scrollingFrame, reason)
    if dumpScheduled[shopType] then return end
    dumpScheduled[shopType] = true

    task.delay(DEBOUNCE_SECONDS, function()
        dumpScheduled[shopType] = false
        -- scrollingFrame might be gone; guard
        if scrollingFrame and scrollingFrame.Parent then
            dumpAll(shopType, scrollingFrame, reason)
        else
            emit("INFO", { ts = os.time(), shop = shopType, msg = "Dump skipped: ScrollingFrame destroyed", reason = tostring(reason) })
        end
    end)
end

-- Hook one item frame, and also keep re-trying if UI children appear later
local function hookItem(shopType, itemFrame, scrollingFrame)
    if not isRealItem(itemFrame) then return end
    if hookedItemFrames[itemFrame] then return end
    hookedItemFrames[itemFrame] = true

    local function tryWireLabels(reason)
        if not itemFrame or not itemFrame.Parent then return end
        if not isRealItem(itemFrame) then return end

        local nameLabel, stockLabel = getItemLabels(shopType, itemFrame)
        if not nameLabel or not stockLabel then
            return
        end

        -- Wire changes (will only wire once per itemFrame; we gate via attributes)
        if not itemFrame:GetAttribute("_shop_wired") then
            itemFrame:SetAttribute("_shop_wired", true)

            stockLabel:GetPropertyChangedSignal("Text"):Connect(function()
                scheduleDump(shopType, scrollingFrame, "StockText changed")
            end)

            nameLabel:GetPropertyChangedSignal("Text"):Connect(function()
                scheduleDump(shopType, scrollingFrame, "Name changed")
            end)

            -- If item becomes visible later
            itemFrame:GetPropertyChangedSignal("Visible"):Connect(function()
                scheduleDump(shopType, scrollingFrame, "Item visibility changed")
            end)

            emit("INFO", {
                ts = os.time(),
                shop = shopType,
                msg = "Item wired",
                ui_name = itemFrame.Name,
            })

            -- snapshot right away for this item appearance
            scheduleDump(shopType, scrollingFrame, reason or "Item wired")
        end
    end

    -- First attempt now
    tryWireLabels("hookItem initial")

    -- If MainInfo/labels are created later, wire when they appear
    itemFrame.DescendantAdded:Connect(function(_d)
        -- Small delay to let UI settle
        task.wait(0.03)
        tryWireLabels("DescendantAdded")
    end)
end

local function hookScrollingFrame(shopType, scrollingFrame)
    if not scrollingFrame or not scrollingFrame.Parent then return end
    if hookedScrollFrames[scrollingFrame] then return end
    hookedScrollFrames[scrollingFrame] = true

    -- existing
    for _, item in ipairs(scrollingFrame:GetChildren()) do
        hookItem(shopType, item, scrollingFrame)
    end

    -- new
    scrollingFrame.ChildAdded:Connect(function(item)
        task.wait(0.05)
        hookItem(shopType, item, scrollingFrame)
    end)

    -- if items are removed/readded rapidly, still dump on structural changes
    scrollingFrame.ChildRemoved:Connect(function(_item)
        scheduleDump(shopType, scrollingFrame, "ChildRemoved")
    end)

    emit("INFO", { ts = os.time(), shop = shopType, msg = "hookScrollingFrame attached", path = scrollingFrame:GetFullName() })
end

local function hookShop(shopType, gui)
    local frame = gui:WaitForChild("Frame", 10)
    if not frame then
        emit("ERROR", { ts = os.time(), shop = shopType, msg = "Frame not found" })
        return
    end

    local scrollingFrame = frame:WaitForChild("ScrollingFrame", 10)
    if not scrollingFrame then
        emit("ERROR", { ts = os.time(), shop = shopType, msg = "ScrollingFrame not found" })
        return
    end

    hookScrollingFrame(shopType, scrollingFrame)

    -- in case they recreate ScrollingFrame
    gui.DescendantAdded:Connect(function(d)
        if d:IsA("ScrollingFrame") and d.Name == "ScrollingFrame" then
            task.wait(0.05)
            emit("INFO", { ts = os.time(), shop = shopType, msg = "New ScrollingFrame detected", path = d:GetFullName() })
            hookScrollingFrame(shopType, d)
            scheduleDump(shopType, d, "New ScrollingFrame detected")
        end
    end)

    -- initial snapshot
    scheduleDump(shopType, scrollingFrame, "startup")
end

-- =======================
-- SEED TIMER HEARTBEAT
-- =======================
local function startSeedTimer(seedShopGui)
    local timerLabel = seedShopGui
        :WaitForChild("Frame")
        :WaitForChild("TopBar")
        :WaitForChild("Timer")

    task.spawn(function()
        local last = nil
        while true do
            task.wait(TIMER_INTERVAL)
            if not timerLabel or not timerLabel.Parent then
                emit("INFO", { ts = os.time(), shop = "SeedShop", msg = "Timer label destroyed, timer loop stopped" })
                break
            end

            local v = tostring(timerLabel.Text)
            if v ~= last then
                last = v
                emit("TIMER", { shop = "SeedShop", ts = os.time(), value = v })
            end
        end
    end)

    emit("INFO", { ts = os.time(), shop = "SeedShop", msg = "Timer heartbeat started" })
end

-- =======================
-- START
-- =======================
local seedGui = keepGuiEnabled("SeedShop")
local gearGui = keepGuiEnabled("GearShop")

hookShop("SeedShop", seedGui)
hookShop("GearShop", gearGui)

startSeedTimer(seedGui)

-- if something appears later (rare, but safe)
pg.ChildAdded:Connect(function(child)
    if child.Name == "SeedShop" then
        local g = keepGuiEnabled("SeedShop")
        hookShop("SeedShop", g)
        startSeedTimer(g)
    elseif child.Name == "GearShop" then
        local g = keepGuiEnabled("GearShop")
        hookShop("GearShop", g)
    end
end)
